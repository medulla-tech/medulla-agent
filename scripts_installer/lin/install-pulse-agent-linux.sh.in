#!/bin/bash
#
# (c) 2016-2023 Siveo, http://www.siveo.net
# (c) 2024-2025 Medulla, http://www.medulla-tech.io
#
# $Id$
#
# This file is part of MMC, http://www.medulla-tech.io
#
# MMC is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# any later version.
#
# MMC is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with MMC; If not, see <http://www.gnu.org/licenses/>.

# """
# This script is designed to generate Medulla XMPP agent for Linux
# """

BASE_URL="@@BASE_URL@@"
INVENTORY_TAG="@@INVENTORY_TAG@@"
AGENT_VERSION="@@AGENT_VERSION@@"
PULSE_AGENT_FILENAME="pulse-xmpp-agent-@@AGENT_VERSION@@.tar.gz"
AGENT_PLUGINS_FILENAME="pulse-machine-plugins-@@AGENT_VERSION@@.tar.gz"
VNC_PASSWORD="@@VNC_PASSWORD@@"
SSH_PORT="@@SSH_PORT@@"

check_root() {
    if [ "$(id -u)" != "0" ]; then
        echo "This script must be run as root" 1>&2
        exit 1
    fi
}

check_distro() {
    if [ ! -e /etc/os-release ]; then
        echo "We are not able to find your linux distibution"
    else
        DISTRO=`cat /etc/os-release | grep ^ID= | cut -f2 -d'='`
        VERSION=`cat /etc/os-release | grep ^VERSION_ID= | cut -f2 -d'=' | sed 's/"//g'`
    fi
    case "$DISTRO" in
        debian|ubuntu|zorin)
            ;;
        *)
            echo "We do not support your distribution yet"
            exit 1
            ;;
    esac
}

install_agent_deps_ubuntu() {
    # Install Python 3.11
    apt update
    apt install -y software-properties-common
    add-apt-repository -y ppa:deadsnakes/ppa
    apt install -y python3.11 python3.11-venv python3.11-dev python3.11-distutils
    # Install pip for Python 3.11
    python3.11 -m ensurepip --upgrade
    # Set Python 3.11 as default python3
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1
    update-alternatives --set python3 /usr/bin/python3.11
    # Install required packages
    apt install -y crudini net-tools fusioninventory-agent openssh-server rsync x11vnc xrdp sudo syncthing 
    # Remove deadsnakes repository
    rm -f /etc/apt/sources.list.d/deadsnakes-ubuntu-ppa-noble.sources
    apt update
}

install_agent_deps_debian12() {
    # Install Python 3.11
    apt update
    apt install -y python3.11 python3.11-venv python3.11-dev python3.11-distutils
    # Install pip for Python 3.11
    python3.11 -m ensurepip --upgrade
    # Set Python 3.11 as default python3
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1
    update-alternatives --set python3 /usr/bin/python3.11
    # Install required packages
    apt install -y crudini net-tools fusioninventory-agent openssh-server rsync x11vnc xrdp sudo syncthing 
}

download_agent_files() {
    # Delete any existing temp directory
    rm -rf /tmp/medulla
    # Create temp directory and download files
    mkdir -p /tmp/medulla
    cd /tmp/medulla
    wget ${BASE_URL}/${PULSE_AGENT_FILENAME}
    wget ${BASE_URL}/${AGENT_PLUGINS_FILENAME}
    wget ${BASE_URL}/medulla-ca-chain.cert.pem
    wget ${BASE_URL}/medulla-rootca.cert.pem
    wget ${BASE_URL}/config/agentconf.ini
    wget ${BASE_URL}/config/agentconf.ini.tpl
    wget ${BASE_URL}/config/inventory.ini
    wget ${BASE_URL}/config/manage_scheduler_machine.ini
    wget ${BASE_URL}/config/start_machine.ini
    wget ${BASE_URL}/config/startupdate.ini
    wget ${BASE_URL}/config/updatebackupclient.ini
    wget ${BASE_URL}/config/am___server_tcpip.ini
}   

setup_agent() {
    # Create pulseuser if not exists
    if ! id -u pulseuser >/dev/null 2>&1; then
        echo "Creating pulseuser ..."
        adduser --system --group --home /home/pulseuser --shell /bin/rbash --disabled-password pulseuser
    fi
    if ! [ -d "/home/pulseuser/.ssh" ]; then
        echo "Creating missing SSH profile ..."
        mkdir -p /home/pulseuser/.ssh
    fi
    touch /home/pulseuser/.ssh/authorized_keys
    chown -R pulseuser: /home/pulseuser
    chmod -R 700 /home/pulseuser
    chmod 600 /home/pulseuser/.ssh/authorized_keys

    # Setting up SSH daemon
    echo "Setting up SSH daemon ..."
    sed -i "s/^#?Port .*$/Port ${SSH_PORT}/" /etc/ssh/sshd_config
    echo -e "PubkeyAcceptedAlgorithms +ssh-rsa\nHostKeyAlgorithms +ssh-rsa" > /etc/ssh/sshd_config.d/medulla.conf
    systemctl restart ssh

    # Setup sudo for pulseuser
    echo "Setting up sudo for pulseuser ..."
    echo "pulseuser ALL=(ALL) NOPASSWD: /usr/bin/rsync" > /etc/sudoers.d/pulseuser

    # Setup RDP server
    echo "Setting up RDP server ..."
    systemctl enable xrdp
    systemctl start xrdp

    # Setup VNC server
    echo "Setting up VNC server ..."
    if ! [ -d "/home/pulseuser/.vnc" ]; then
        mkdir -p /home/pulseuser/.vnc
    fi
    x11vnc -storepasswd ${VNC_PASSWORD} /home/pulseuser/.vnc/passwd

    # Install CA certificates
    echo "Installing CA certificates ..."
    CERT_DIR="/usr/local/share/ca-certificates/"
    cp /tmp/medulla/medulla-ca-chain.cert.pem ${CERT_DIR}
    cp /tmp/medulla/medulla-rootca.cert.pem ${CERT_DIR}
    openssl x509 -in ${CERT_DIR}/medulla-ca-chain.cert.pem -inform PEM -out ${CERT_DIR}/medulla-ca-chain.crt
    openssl x509 -in ${CERT_DIR}/medulla-rootca.cert.pem -inform PEM -out ${CERT_DIR}/medulla-rootca.crt
    update-ca-certificates

    # Copy agent configuration files
    echo "Copying agent configuration files ..."
    CONFIG_DIR="/etc/pulse-xmpp-agent/"
    if [ ! -d "${CONFIG_DIR}" ]; then
        mkdir -p ${CONFIG_DIR}
    fi
    cp /tmp/medulla/*.ini ${CONFIG_DIR}
    cp /tmp/medulla/agentconf.ini.tpl ${CONFIG_DIR}
}

install_agent() {
    echo "Installing Medulla XMPP agent ..."
    python3.11 -m venv /opt/medulla
    /opt/medulla/bin/python3.11 -m pip install ${PULSE_AGENT_FILENAME} ${AGENT_PLUGINS_FILENAME}
}

create_service () {
    echo "Creating systemd service for Medulla XMPP agent ..."
    local PYTHON_EXE="/opt/medulla/bin/python3.11"
    local PYTHON_DIR="/opt/medulla/lib/python3.11/site-packages"
    if [ ! -d "/usr/lib/systemd/system/" ]; then
        mkdir -p /usr/lib/systemd/system/
    fi
    cat <<EOF > /usr/lib/systemd/system/pulse-xmpp-agent-machine.service
[Unit]
Description=Medulla XMPP Agent ( Machine )

[Service]
Type=simple
ExecStart=${PYTHON_EXE} ${PYTHON_DIR}/pulse_xmpp_agent/launcher.py -t machine
Restart=always
RestartSec=1

[Install]
WantedBy=multi-user.target
EOF
}

configure_inventory_tag() {
    TAG="$1"
    echo "Configuring inventory tag: ${TAG}"
    crudini --set /etc/pule-xmpp-agent/inventory.ini parameters inventoytag "${TAG}"
}

start_agent() {
    echo "Starting Medulla XMPP agent ..."
    chmod +x /opt/medulla/lib/python3.11/site-packages/pulse_xmpp_agent/launcher.py
    [ ! -d "/var/log/pulse" ] && mkdir /var/log/pulse

    # Enable and start the service
    systemctl daemon-reload
	systemctl enable pulse-xmpp-agent-machine.service
	systemctl start pulse-xmpp-agent-machine.service
}


check_root
check_distro
case "$DISTRO" in
    ubuntu|zorin) 
        install_agent_deps_ubuntu 
        ;;
    debian)
        if [ "$VERSION" == "12" ]; then
            install_agent_deps_debian12
        fi
        ;;
esac
download_agent_files
setup_agent
install_agent
if [[ ${INVENTORY_TAG} != "" ]]; then
    configure_inventory_tag ${INVENTORY_TAG}
fi
create_service
start_agent
