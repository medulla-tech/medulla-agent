#!/usr/bin/make -f

# Stolen from cdbs, we need this.
DEB_VERSION := $(shell dpkg-parsechangelog | egrep '^Version:' | cut -f 2 -d ' ')
DEB_NOEPOCH_VERSION := $(shell echo $(DEB_VERSION) | cut -d: -f2-)
DEB_UPSTREAM_VERSION := $(shell echo $(DEB_NOEPOCH_VERSION) | sed 's/-[^-]*$$//')
VERSION_XMPP_AGENT=2.0.6
VERSION_KIOSK_INTERFACE=0.2
FILETREE_VERSION=0.1
BRANCH=spo

# Used during building to set the version
export CFLAGS=-DVERSION=\"$(DEB_UPSTREAM_VERSION)\"

%:
	dh $@ --buildsystem=python_distutils --with=python2

override_dh_install:
	dh_install --list-missing

override_dh_auto_build:
	dh_auto_build

override_dh_auto_install:
	dh_auto_install
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent
	cp -fr pulse_xmpp_agent/* $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent
	mkdir -p $(CURDIR)/debian/tmp/var/log/pulse/
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/systemd/system
	mkdir -p $(CURDIR)/debian/tmp/var/lib/pulse2/clients/config/
	cp -fr pulse_xmpp_agent/config/systemd/* $(CURDIR)/debian/tmp/usr/lib/systemd/system
	cp -fv ./scripts_installer/lin/*.service $(CURDIR)/debian/tmp/usr/lib/systemd/system
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/pulse-xmpp-agent-relay.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/pulse-xmpp-agent-log.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/pulse-package-watching.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/pulse-xmpp-agent-machine.service
	mkdir -p $(CURDIR)/debian/tmp/var/lib/pulse2/xmpp_baseplugin
	mkdir -p $(CURDIR)/debian/tmp/var/lib/pulse2/xmpp_basepluginscheduler
	cp -frv pulse_xmpp_agent/plugins_common/plugin_* $(CURDIR)/debian/tmp/var/lib/pulse2/xmpp_baseplugin
	cp -frv pulse_xmpp_agent/pluginsmachine/plugin_* $(CURDIR)/debian/tmp/var/lib/pulse2/xmpp_baseplugin
	cp -frv pulse_xmpp_agent/pluginsrelay/plugin_* $(CURDIR)/debian/tmp/var/lib/pulse2/xmpp_baseplugin
	cp -fv  pulse_xmpp_agent/descriptor_scheduler_common/scheduling_* $(CURDIR)/debian/tmp/var/lib/pulse2/xmpp_basepluginscheduler
	cp -fv  pulse_xmpp_agent/descriptor_scheduler_machine/scheduling_* $(CURDIR)/debian/tmp/var/lib/pulse2/xmpp_basepluginscheduler
	cp -fv  pulse_xmpp_agent/descriptor_scheduler_relay/scheduling_* $(CURDIR)/debian/tmp/var/lib/pulse2/xmpp_basepluginscheduler
	cp -fv pulse_xmpp_agent/plugins_common/plugin_* $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/pluginsrelay
	cp -fv pulse_xmpp_agent/plugins_common/plugin_* $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/pluginsmachine
	cp -fv pulse_xmpp_agent/pluginsmachine/plugin_* $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/pluginsmachine
	cp -fr pulse_xmpp_agent/pluginsrelay/plugin_* $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/pluginsrelay
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/descriptor_scheduler_machine/
	cp -fv pulse_xmpp_agent/descriptor_scheduler_machine/scheduling_*.py $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/descriptor_scheduler_machine/
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/descriptor_scheduler_relay/
	cp -fv pulse_xmpp_agent/descriptor_scheduler_relay/scheduling_*.py $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/descriptor_scheduler_relay/
	cp -fv pulse_xmpp_agent/descriptor_scheduler_common/scheduling_*.py $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/descriptor_scheduler_machine/
	cp -fv pulse_xmpp_agent/descriptor_scheduler_common/scheduling_*.py $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/descriptor_scheduler_relay/
	mkdir -p $(CURDIR)/debian/tmp/etc/pulse-xmpp-agent
	cp pulse_xmpp_agent/config/guacamoleconf.ini $(CURDIR)/debian/tmp/etc/pulse-xmpp-agent
	cp pulse_xmpp_agent/config/downloadfile.ini $(CURDIR)/debian/tmp/etc/pulse-xmpp-agent
	cp pulse_xmpp_agent/config/downloadfileexpert.ini $(CURDIR)/debian/tmp/etc/pulse-xmpp-agent
	cp pulse_xmpp_agent/config/applicationdeploymentjson.ini $(CURDIR)/debian/tmp/etc/pulse-xmpp-agent
	cp pulse_xmpp_agent/config/guacamole.ini $(CURDIR)/debian/tmp/etc/pulse-xmpp-agent
	cp pulse_xmpp_agent/config/reverse_ssh_on.ini $(CURDIR)/debian/tmp/etc/pulse-xmpp-agent
	cp pulse_xmpp_agent/config/wakeonlan.ini $(CURDIR)/debian/tmp/etc/pulse-xmpp-agent
	cp pulse_xmpp_agent/config/relayconf.ini $(CURDIR)/debian/tmp/etc/pulse-xmpp-agent
	cp pulse_xmpp_agent/config/package_watching.ini $(CURDIR)/debian/tmp/etc/pulse-xmpp-agent
	mkdir -p $(CURDIR)/debian/tmp/etc/logrotate.d/
	cp contrib/scripts/pulse-xmpp-agent-relay.logrotate $(CURDIR)/debian/tmp/etc/logrotate.d/pulse-xmpp-agent-relay
	chmod +x $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/pulse-xmpp-agent-log.py
	chmod +x $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/agentxmpp.py
	chmod +x $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/package_watching.py
	chmod +x $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_agent/launcher.py
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_master_substitute/
	cp pulse_xmpp_master_substitute/agentmastersubstitute.py $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_master_substitute/
	cp pulse_xmpp_master_substitute/agentversion $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_master_substitute/
	cp -r pulse_xmpp_master_substitute/bin/ $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_master_substitute/
	cp -r pulse_xmpp_master_substitute/lib/  $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_master_substitute/
	cp -r pulse_xmpp_master_substitute/pluginsmastersubstitute/ $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_master_substitute/
	cp -r pulse_xmpp_master_substitute/script/ $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_master_substitute/
	mkdir -p $(CURDIR)/debian/tmp/etc/pulse-xmpp-agent-substitute/
	cp pulse_xmpp_master_substitute/config/*.ini $(CURDIR)/debian/tmp/etc/pulse-xmpp-agent-substitute/
	cp -fr pulse_xmpp_master_substitute/config/systemd/* $(CURDIR)/debian/tmp/usr/lib/systemd/system
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/pulse-xmpp-master-substitute-registration.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/pulse-xmpp-master-substitute-inventory.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/pulse-xmpp-master-substitute-assessor.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/pulse-xmpp-master-substitute-subscription.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/pulse-xmpp-master-substitute-logger.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/pulse-xmpp-master-substitute-deployment.service
	chmod +x $(CURDIR)/debian/tmp/usr/lib/python2.7/dist-packages/pulse_xmpp_master_substitute/agentmastersubstitute.py
	#Â We create the installer part now
	mkdir -p $(DESTDIR)/tmp
	GIT_SSL_NO_VERIFY=true git clone https://github.com/pulse-project/pulse-xmpp-agent.git -b ${BRANCH}
	mv pulse-xmpp-agent pulse-xmpp-agent-${VERSION_XMPP_AGENT}
	tar czvf pulse-xmpp-agent-${VERSION_XMPP_AGENT}.tar.gz pulse-xmpp-agent-${VERSION_XMPP_AGENT}
	rm -fr pulse-xmpp-agent/
	mkdir -p var/lib/pulse2/clients
	mv  $(CURDIR)/pulse-xmpp-agent-${VERSION_XMPP_AGENT}.tar.gz var/lib/pulse2/clients
	#GIT_SSL_NO_VERIFY=true git clone https://github.com/pulse-project/kiosk-interface.git
	#mv kiosk-interface kiosk-interface-${VERSION_KIOSK_INTERFACE}
	#tar czvf kiosk-interface-${VERSION_KIOSK_INTERFACE}.tar.gz kiosk-interface-${VERSION_KIOSK_INTERFACE}
	#mv kiosk-interface-${VERSION_KIOSK_INTERFACE}.tar.gz var/lib/pulse2/clients
	tar xzvf var/lib/pulse2/clients/pulse-xmpp-agent-${VERSION_XMPP_AGENT}.tar.gz -C $(DESTDIR)/tmp
	mkdir -p var/lib/pulse2/xmpp_baseremoteagent
	cp -frv $(DESTDIR)/tmp/pulse-xmpp-agent-${VERSION_XMPP_AGENT}/pulse_xmpp_agent/* var/lib/pulse2/xmpp_baseremoteagent/
	rm -fv var/lib/pulse2/xmpp_baseremoteagent/managedbkiosk.py
	mkdir -p etc/mmc/plugins/
	mkdir -p var/lib/pulse2/clients/config/
	cp $(DESTDIR)/tmp/pulse-xmpp-agent-${VERSION_XMPP_AGENT}/pulse_xmpp_agent/config/agentconf.ini var/lib/pulse2/clients/config/
	cp $(DESTDIR)/tmp/pulse-xmpp-agent-${VERSION_XMPP_AGENT}/pulse_xmpp_agent/config/manage_scheduler.ini var/lib/pulse2/clients/config/
	cp scripts_installer/generate-pulse-agent.sh var/lib/pulse2/clients
	cp scripts_installer/generate-agent-package var/lib/pulse2/clients
	cp scripts_installer/generate-agent-deps-package var/lib/pulse2/clients
	cp scripts_installer/generate-netcheck-package var/lib/pulse2/clients
	cp scripts_installer/generate-service-package var/lib/pulse2/clients
	cp scripts_installer/HEADER.html var/lib/pulse2/clients
	cp scripts_installer/style.css var/lib/pulse2/clients
	mkdir -p var/lib/pulse2/clients/win
	cp scripts_installer/win/generate-pulse-agent-win.sh var/lib/pulse2/clients/win
	cp scripts_installer/win/agent-installer.nsi.in var/lib/pulse2/clients/win
	cp scripts_installer/win/pulse-agent-task.xml var/lib/pulse2/clients/win
	cp scripts_installer/win/pulse-filetree-generator.exe var/lib/pulse2/clients/win
	#cp scripts_installer/generate-kiosk-package var/lib/pulse2/clients/win
	mkdir -p var/lib/pulse2/clients/lin
	cp -r scripts_installer/lin/* var/lib/pulse2/clients/lin
	mkdir -p var/lib/pulse2/clients/mac
	cp scripts_installer/mac/generate-pulse-agent-mac.sh var/lib/pulse2/clients/mac
	cp scripts_installer/mac/Info.plist.in var/lib/pulse2/clients/mac
	cp scripts_installer/mac/postflight.in var/lib/pulse2/clients/mac
	cp scripts_installer/mac/net.siveo.pulse_xmpp_agent.plist var/lib/pulse2/clients/mac
	cp scripts_installer/mac/rbash var/lib/pulse2/clients/mac
	cp scripts_installer/mac/runpulseagent var/lib/pulse2/clients/mac
	mkdir -p var/lib/pulse2/clients/win/libs
	cp -fr scripts_installer/win/nsis_libs/* var/lib/pulse2/clients/win/libs
	mkdir -p var/lib/pulse2/clients/win/artwork
	cp -fr scripts_installer/win/artwork/* var/lib/pulse2/clients/win/artwork
	chmod +x var/lib/pulse2/clients/*.sh
	chmod +x var/lib/pulse2/clients/generate-agent-package
	chmod +x var/lib/pulse2/clients/generate-agent-deps-package
	chmod +x var/lib/pulse2/clients/generate-netcheck-package
	chmod +x var/lib/pulse2/clients/generate-service-package
	#chmod +x var/lib/pulse2/clients/win/generate-kiosk-package
	GIT_SSL_NO_VERIFY=true git clone https://github.com/pulse-project/pulse-filetree-generator.git
	mv pulse-filetree-generator pulse-filetree-generator-${FILETREE_VERSION}
	g++ -O3 -std=c++11 pulse-filetree-generator-${FILETREE_VERSION}/linux_macos/pulse-filetree-generator.cpp -o pulse-filetree-generator
	mkdir -p var/lib/pulse2/clients/lin/deb/pulse-agent-linux/usr/sbin
	cp pulse-filetree-generator var/lib/pulse2/clients/lin/deb/pulse-agent-linux/usr/sbin
	chmod +x var/lib/pulse2/clients/lin/deb/pulse-agent-linux/usr/sbin/pulse-filetree-generator
	mkdir -p var/lib/pulse2/clients/lin/rpm/package/SOURCES
	cp pulse-filetree-generator var/lib/pulse2/clients/lin/rpm/package/SOURCES
	chmod +x var/lib/pulse2/clients/lin/rpm/package/SOURCES/pulse-filetree-generator
	mv pulse-filetree-generator var/lib/pulse2/clients/mac
	chmod +x var/lib/pulse2/clients/mac/pulse-filetree-generator
	cp scripts_installer/win/create-profile.ps1 var/lib/pulse2/clients/win/
	cp scripts_installer/win/pulse-service.py var/lib/pulse2/clients/win/
	cp scripts_installer/win/netcheck-service.py var/lib/pulse2/clients/win/
	cp scripts_installer/win/networkevents.py var/lib/pulse2/clients/win/
