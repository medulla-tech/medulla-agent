#!/usr/bin/make -f

# Stolen from cdbs, we need this.
DEB_VERSION := $(shell dpkg-parsechangelog | egrep '^Version:' | cut -f 2 -d ' ')
DEB_NOEPOCH_VERSION := $(shell echo $(DEB_VERSION) | cut -d: -f2-)
DEB_UPSTREAM_VERSION := $(shell echo $(DEB_NOEPOCH_VERSION) | sed 's/-[^-]*$$//')
VERSION_XMPP_AGENT=3.1.0
VERSION_KIOSK_INTERFACE=1.0.0
FILETREE_VERSION=0.1
BRANCH=integration

PYVER=3
# Used during building to set the version
export CFLAGS=-DVERSION=\"$(DEB_UPSTREAM_VERSION)\"

%:
	dh $@ --buildsystem=pybuild --with=python3

override_dh_auto_test:

override_dh_auto_install:
	dh_auto_install
	# Move into a non python dependant folder.
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/
	mv -f $(CURDIR)/debian/tmp/usr/lib/python${PYVER}.11/dist-packages/* $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/ 
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_agent
	cp -fr medulla_agent/* $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_agent
	rm -fr $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_agent/config
	rm -fr $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_agent/descriptor_scheduler_common
	rm -fr $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_agent/plugins_common
	rm -fr $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_agent/descriptor_scheduler_machine/scheduling_*.py
	rm -fr $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_agent/pluginsmachine/plugin_*.py
	cp -fv medulla_agent/plugins_common/plugin_* $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_agent/pluginsrelay
	cp -fv medulla_agent/descriptor_scheduler_common/scheduling_*.py $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_agent/descriptor_scheduler_relay/
	chmod +x $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_agent/agentxmpp.py
	chmod +x $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_agent/package_watching.py
	chmod +x $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_agent/launcher.py
	mkdir -p $(CURDIR)/debian/tmp/var/log/medulla/
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/systemd/system
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/clients/config/
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/python3/dist-packages/medulla_master_substitute/sessiondeploysubstitute
	touch $(CURDIR)/debian/tmp/usr/lib/python3/dist-packages/medulla_master_substitute/sessiondeploysubstitute/EMPTY
	cp -fr medulla_agent/config/systemd/* $(CURDIR)/debian/tmp/usr/lib/systemd/system
	cp -fv ./scripts_installer/lin/*.service $(CURDIR)/debian/tmp/usr/lib/systemd/system
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/medulla-agent-relay.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/medulla-package-watching.service
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_baseplugin
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_basepluginscheduler
	cp -frv medulla_agent/plugins_common/plugin_* $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_baseplugin
	cp -frv medulla_agent/pluginsmachine/plugin_* $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_baseplugin
	cp -frv medulla_agent/pluginsrelay/plugin_* $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_baseplugin
	cp -fv  medulla_agent/descriptor_scheduler_common/scheduling_* $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_basepluginscheduler
	cp -fv  medulla_agent/descriptor_scheduler_machine/scheduling_* $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_basepluginscheduler
	cp -fv  medulla_agent/descriptor_scheduler_relay/scheduling_* $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_basepluginscheduler
	mkdir -p $(CURDIR)/debian/tmp/etc/medulla-agent
	cp medulla_agent/config/guacamoleconf.ini $(CURDIR)/debian/tmp/etc/medulla-agent
	cp medulla_agent/config/downloadfile.ini $(CURDIR)/debian/tmp/etc/medulla-agent
	cp medulla_agent/config/downloadfileexpert.ini $(CURDIR)/debian/tmp/etc/medulla-agent
	cp medulla_agent/config/applicationdeploymentjson.ini $(CURDIR)/debian/tmp/etc/medulla-agent
	cp medulla_agent/config/guacamole.ini $(CURDIR)/debian/tmp/etc/medulla-agent
	cp medulla_agent/config/reverse_ssh_on.ini $(CURDIR)/debian/tmp/etc/medulla-agent
	cp medulla_agent/config/wakeonlan.ini $(CURDIR)/debian/tmp/etc/medulla-agent
	cp medulla_agent/config/relayconf.ini $(CURDIR)/debian/tmp/etc/medulla-agent
	cp medulla_agent/config/package_watching.ini $(CURDIR)/debian/tmp/etc/medulla-agent
	cp medulla_agent/config/manage_scheduler_relay.ini $(CURDIR)/debian/tmp/etc/medulla-agent
	cp medulla_agent/config/start_relay.ini $(CURDIR)/debian/tmp/etc/medulla-agent
	cp medulla_agent/config/ars___server_tcpip.ini $(CURDIR)/debian/tmp/etc/medulla-agent/ars___server_tcpip.ini
	mkdir -p $(CURDIR)/debian/tmp/etc/logrotate.d/
	cp contrib/scripts/medulla-agent-relay.logrotate $(CURDIR)/debian/tmp/etc/logrotate.d/medulla-agent-relay
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_master_substitute/
	cp medulla_master_substitute/agentmastersubstitute.py $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_master_substitute/
	cp medulla_master_substitute/agentversion $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_master_substitute/
	cp -r medulla_master_substitute/bin/ $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_master_substitute/
	cp -r medulla_master_substitute/lib/  $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_master_substitute/
	cp -r medulla_master_substitute/pluginsmastersubstitute/ $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_master_substitute/
	cp -r medulla_master_substitute/script/ $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_master_substitute/
	mkdir -p $(CURDIR)/debian/tmp/etc/medulla-agent-substitute/
	cp medulla_master_substitute/config/*.ini $(CURDIR)/debian/tmp/etc/medulla-agent-substitute/
	cp -fr medulla_master_substitute/config/systemd/* $(CURDIR)/debian/tmp/usr/lib/systemd/system
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/medulla-master-substitute-registration.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/medulla-master-substitute-inventory.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/medulla-master-substitute-assessor.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/medulla-master-substitute-subscription.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/medulla-master-substitute-logger.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/medulla-master-substitute-deployment.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/medulla-master-substitute-reconfigurator.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/medulla-master-substitute-monitoring.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/medulla-master-substitute-master.service
	sed -i 's,site-packages,dist-packages,g' -i $(CURDIR)/debian/tmp/usr/lib/systemd/system/medulla-master-substitute-updates.service
	chmod +x $(CURDIR)/debian/tmp/usr/lib/python${PYVER}/dist-packages/medulla_master_substitute/agentmastersubstitute.py
	#Â We create the installer part now
	mkdir medulla-agent-${VERSION_XMPP_AGENT}
	mkdir -p medulla-machine-plugins-${VERSION_XMPP_AGENT}/medulla_agent/pluginsmachine
	mkdir -p medulla-machine-plugins-${VERSION_XMPP_AGENT}/medulla_agent/descriptor_scheduler_machine
	cp -frv medulla_agent medulla-agent-${VERSION_XMPP_AGENT}/
	cp -fv packaging/python/agent_setup.py medulla-agent-${VERSION_XMPP_AGENT}/setup.py
	cp -fv packaging/python/machineplugins_setup.py medulla-machine-plugins-${VERSION_XMPP_AGENT}/setup.py
	cp -fv packaging/python/LICENSE medulla-agent-${VERSION_XMPP_AGENT}
	cp -fv packaging/python/README.md medulla-agent-${VERSION_XMPP_AGENT}
	cp -fv packaging/python/MANIFEST.in medulla-agent-${VERSION_XMPP_AGENT}
	cp -fv packaging/python/LICENSE medulla-machine-plugins-${VERSION_XMPP_AGENT}
	cp -fv packaging/python/README.md medulla-machine-plugins-${VERSION_XMPP_AGENT}
	rm -fr medulla-agent-${VERSION_XMPP_AGENT}/medulla_agent/config
	mv medulla-agent-${VERSION_XMPP_AGENT}/medulla_agent/plugins_common/plugin_*.py medulla-machine-plugins-${VERSION_XMPP_AGENT}/medulla_agent/pluginsmachine
	mv medulla-agent-${VERSION_XMPP_AGENT}/medulla_agent/descriptor_scheduler_common/scheduling_*.py medulla-machine-plugins-${VERSION_XMPP_AGENT}/medulla_agent/descriptor_scheduler_machine
	mv medulla-agent-${VERSION_XMPP_AGENT}/medulla_agent/pluginsmachine/plugin_*.py medulla-machine-plugins-${VERSION_XMPP_AGENT}/medulla_agent/pluginsmachine
	mv medulla-agent-${VERSION_XMPP_AGENT}/medulla_agent/descriptor_scheduler_machine/scheduling_*.py medulla-machine-plugins-${VERSION_XMPP_AGENT}/medulla_agent/descriptor_scheduler_machine
	rm -fr medulla-agent-${VERSION_XMPP_AGENT}/medulla_agent/descriptor_scheduler_common/
	rm -fr medulla-agent-${VERSION_XMPP_AGENT}/medulla_agent/descriptor_scheduler_relay/scheduling_*.py
	rm -fr medulla-agent-${VERSION_XMPP_AGENT}/medulla_agent/plugins_common/
	rm -fr medulla-agent-${VERSION_XMPP_AGENT}/medulla_agent/pluginsrelay/plugin_*.py
	tar czvf medulla-agent-${VERSION_XMPP_AGENT}.tar.gz medulla-agent-${VERSION_XMPP_AGENT}
	rm -fr medulla-agent-${VERSION_XMPP_AGENT}
	tar czvf medulla-machine-plugins-${VERSION_XMPP_AGENT}.tar.gz medulla-machine-plugins-${VERSION_XMPP_AGENT}
	rm -fr medulla-machine-plugins-${VERSION_XMPP_AGENT}
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/clients
	mv  medulla-agent-${VERSION_XMPP_AGENT}.tar.gz $(CURDIR)/debian/tmp/var/lib/medulla/clients
	mv  medulla-machine-plugins-${VERSION_XMPP_AGENT}.tar.gz $(CURDIR)/debian/tmp/var/lib/medulla/clients
	GIT_SSL_NO_VERIFY=true git clone --branch ${BRANCH} https://github.com/medulla-project/kiosk-interface.git
	mv kiosk-interface kiosk-interface-${VERSION_KIOSK_INTERFACE}
	tar czvf kiosk-interface-${VERSION_KIOSK_INTERFACE}.tar.gz kiosk-interface-${VERSION_KIOSK_INTERFACE}
	rm -fr kiosk-interface-${VERSION_KIOSK_INTERFACE}
	mv kiosk-interface-${VERSION_KIOSK_INTERFACE}.tar.gz $(CURDIR)/debian/tmp/var/lib/medulla/clients
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_baseremoteagent
	cp -frv medulla_agent/* $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_baseremoteagent/
	rm -frv $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_baseremoteagent/config
	rm -frv $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_baseremoteagent/descriptor_scheduler_common
	rm -frv $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_baseremoteagent/plugins_common
	rm -fv $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_baseremoteagent/descriptor_scheduler_machine/scheduling_*.py
	rm -fv $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_baseremoteagent/pluginsmachine/plugin_*.py
	rm -fv $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_baseremoteagent/descriptor_scheduler_relay/scheduling_*.py
	rm -fv $(CURDIR)/debian/tmp/var/lib/medulla/xmpp_baseremoteagent/pluginsrelay/plugin_*.py
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/clients/config/
	cp medulla_agent/config/agentconf.ini $(CURDIR)/debian/tmp/var/lib/medulla/clients/config/
	cp medulla_agent/config/manage_scheduler_machine.ini $(CURDIR)/debian/tmp/var/lib/medulla/clients/config/
	cp medulla_agent/config/inventory.ini $(CURDIR)/debian/tmp/var/lib/medulla/clients/config/
	cp medulla_agent/config/inventory.ini $(CURDIR)/debian/tmp/var/lib/medulla/clients/config/
	cp medulla_agent/config/start_machine.ini $(CURDIR)/debian/tmp/var/lib/medulla/clients/config/
	cp medulla_agent/config/startupdate.ini $(CURDIR)/debian/tmp/var/lib/medulla/clients/config/
	cp medulla_agent/config/updateopenssh.ini $(CURDIR)/debian/tmp/var/lib/medulla/clients/config/
	cp medulla_agent/config/updatetightvnc.ini $(CURDIR)/debian/tmp/var/lib/medulla/clients/config/
	cp medulla_agent/config/updatebackupclient.ini $(CURDIR)/debian/tmp/var/lib/medulla/clients/config/
	cp medulla_agent/config/am___server_tcpip.ini $(CURDIR)/debian/tmp/var/lib/medulla/clients/config/
	cp scripts_installer/generate-medulla-agent.sh $(CURDIR)/debian/tmp/var/lib/medulla/clients
	cp scripts_installer/generate-agent-package $(CURDIR)/debian/tmp/var/lib/medulla/clients
	cp scripts_installer/HEADER.html $(CURDIR)/debian/tmp/var/lib/medulla/clients
	cp scripts_installer/style.css $(CURDIR)/debian/tmp/var/lib/medulla/clients
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/clients/win
	cp scripts_installer/win/generate-medulla-agent-win.sh $(CURDIR)/debian/tmp/var/lib/medulla/clients/win
	cp scripts_installer/win/agent-installer.nsi.in $(CURDIR)/debian/tmp/var/lib/medulla/clients/win
	cp scripts_installer/win/medulla-agent-task.xml $(CURDIR)/debian/tmp/var/lib/medulla/clients/win
	chmod +x $(CURDIR)/debian/tmp/var/lib/medulla/clients/win/generate-medulla-agent-win.sh
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/clients/lin
	cp scripts_installer/lin/generate-medulla-agent-linux.sh $(CURDIR)/debian/tmp/var/lib/medulla/clients/lin
	chmod +x $(CURDIR)/debian/tmp/var/lib/medulla/clients/lin/generate-medulla-agent-linux.sh
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/clients/mac
	cp scripts_installer/mac/generate-medulla-agent-mac.sh $(CURDIR)/debian/tmp/var/lib/medulla/clients/mac
	chmod +x $(CURDIR)/debian/tmp/var/lib/medulla/clients/mac/generate-medulla-agent-mac.sh
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/clients/lin
	cp -r scripts_installer/lin/* $(CURDIR)/debian/tmp/var/lib/medulla/clients/lin
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/clients/mac
	cp scripts_installer/mac/generate-medulla-agent-mac.sh $(CURDIR)/debian/tmp/var/lib/medulla/clients/mac
	cp scripts_installer/mac/Info.plist.in $(CURDIR)/debian/tmp/var/lib/medulla/clients/mac
	cp scripts_installer/mac/postflight.in $(CURDIR)/debian/tmp/var/lib/medulla/clients/mac
	cp scripts_installer/mac/net.siveo.medulla_agent.plist $(CURDIR)/debian/tmp/var/lib/medulla/clients/mac
	cp scripts_installer/mac/rbash $(CURDIR)/debian/tmp/var/lib/medulla/clients/mac
	cp scripts_installer/mac/runmedullaagent $(CURDIR)/debian/tmp/var/lib/medulla/clients/mac
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/clients/win/libs
	cp -fr scripts_installer/win/nsis_libs/* $(CURDIR)/debian/tmp/var/lib/medulla/clients/win/libs
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/clients/win/artwork
	cp -fr scripts_installer/win/artwork/* $(CURDIR)/debian/tmp/var/lib/medulla/clients/win/artwork
	chmod +x $(CURDIR)/debian/tmp/var/lib/medulla/clients/*.sh
	chmod +x $(CURDIR)/debian/tmp/var/lib/medulla/clients/generate-agent-package
	cp medulla_agent/script/create-profile.ps1 $(CURDIR)/debian/tmp/var/lib/medulla/clients/win/
	cp medulla_agent/script/remove-profile.ps1 $(CURDIR)/debian/tmp/var/lib/medulla/clients/win/
	cp scripts_installer/win/medulla-service.py $(CURDIR)/debian/tmp/var/lib/medulla/clients/win/
	cp scripts_installer/win/netcheck-service.py $(CURDIR)/debian/tmp/var/lib/medulla/clients/win/
	cp scripts_installer/win/networkevents.py $(CURDIR)/debian/tmp/var/lib/medulla/clients/win/
	cp scripts_installer/win/powershell-policy-remotesigned.pol $(CURDIR)/debian/tmp/var/lib/medulla/clients/win/
	mkdir -p $(CURDIR)/debian/tmp/var/lib/medulla/script_monitoring
	cp -fv contrib/monitoring/* $(CURDIR)/debian/tmp/var/lib/medulla/script_monitoring/
	cp medulla_agent/bin/medulla_update_notification.py $(CURDIR)/debian/tmp/var/lib/medulla/clients/win/
	cp medulla_agent/bin/medulla_update_notification.py $(CURDIR)/debian/tmp/var/lib/medulla/clients/lin/
	cp medulla_agent/bin/medulla_update_notification.py $(CURDIR)/debian/tmp/var/lib/medulla/clients/mac/
	cp medulla_agent/bin/RunMedullaKiosk.bat $(CURDIR)/debian/tmp/var/lib/medulla/clients/win/
